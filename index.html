<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>レトロドット変換</title>
<style>
  body {
    margin:0;
    font-family: system-ui, -apple-system, sans-serif;
    background:#0f1115;
    color:#e6e6eb;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header { padding:8px; text-align:center; }
  h1 { font-size:16px; margin:6px 0; }
  .panel {
    display:flex; flex-wrap:wrap; gap:8px; justify-content:center;
    padding:8px; background:#0f1115; position:sticky; top:0; z-index:10;
  }
  .panel > * {
    background:#171a21; border:1px solid #2a2f3a; color:#e6e6eb;
    border-radius:8px; padding:6px 10px; font-size:14px;
  }
  .stage {
    width:100vw;
    height:100vh;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
    flex: 1;
  }
  canvas {
    width: 100vw;
    height: 100vh;
    object-fit: contain;
    image-rendering: pixelated;
    display:block;
  }
  video { display:none; }
  .palette-editor { display:flex; flex-wrap:wrap; gap:6px; justify-content:center; padding:6px; }
  .swatch { display:flex; align-items:center; gap:4px; background:#111; border:1px solid #2a2f3a; border-radius:999px; padding:4px 6px; }
  .swatch input[type="color"]{ width:28px; height:28px; border:none; background:none; }
  .hidden { display:none !important; }
  .palette-io { display:flex; gap:6px; flex-wrap:wrap; justify-content:center; }
  .palette-io textarea {
    width: 240px; height: 42px;
    background:#0b0d12; color:#cfd3ff; border:1px solid #2a2f3a; border-radius:6px; padding:6px;
    font-size:12px;
  }
  footer {
    text-align: center;
    font-size: 12px;
    color: #777;
    padding: 10px 0 14px;
  }
</style>
</head>
<body>
<header>
  <h1>レトロ ドット変換</h1>
</header>

<div class="panel">
  <input type="file" id="file" accept="image/*">
  <label>ドット数 <input id="dotSize" type="number" value="100" min="4" max="1024"></label>
  <label>色数 <input id="colorCount" type="number" value="8" min="1"></label>
  <select id="mode">
    <option value="preset">プリセット</option>
    <option value="random">ランダム</option>
    <option value="custom">手動</option>
  </select>
  <select id="preset">
    <option value="sunset2">Sunset 2</option>
    <option value="mono8">モノクロ</option>
    <option value="gb8">古いゲーム風</option>
    <option value="dusty5">くすみカラー</option>
    <option value="vivid5">ビビッド</option>
    <option value="pop5">ポップ</option>
  </select>
  <button id="convert">変換</button>
  <button id="realtime">リアルタイム開始</button>
  <button id="switchCam">フロント/リア切替</button>
  <button id="save">保存</button>
  <button id="saveAll">一括保存</button>
  <button id="saveColors">色保存</button>
</div>

<div class="palette-io">
  <textarea id="paletteText" placeholder="例: 255.000.000,000.000.255,000.255.000"></textarea>
  <button id="loadColors">色読み込み</button>
</div>

<div id="paletteEditor" class="palette-editor"></div>

<div class="stage">
  <canvas id="canvas"></canvas>
  <video id="video" playsinline></video>
</div>

<footer>
  Copyright © 2026 SirogomaAZARASI All rights reserved.
</footer>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script>
const PRESETS = {
  sunset2: [[44,62,76],[66,75,82],[109,102,94],[163,132,104],[189,141,101],[211,158,108],[255,192,118],[204,206,185]],
  mono8: [[0,0,0],[64,64,64],[128,128,128],[192,192,192],[255,255,255]],
  gb8: [[15,56,15],[48,98,48],[139,172,15],[155,188,15],[220,240,140],[255,255,255]],
  dusty5: [[37,40,61],[111,146,131],[166,117,161],[206,162,172],[239,217,206]],
  vivid5: [[41,47,54],[78,205,196],[252,171,16],[255,107,107],[255,255,255]],
  pop5: [[29,47,111],[131,144,250],[250,199,72],[249,233,236],[36,130,50]]
};

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { willReadFrequently:true });
const fileInput = document.getElementById('file');
const dotSizeInput = document.getElementById('dotSize');
const saveAllBtn = document.getElementById('saveAll');
let img = new Image();

function fitSize(sw,sh,d){
  const a=sw/sh;
  return sw>=sh ? [d, Math.round(d/a)] : [Math.round(d*a), d];
}

function quantize(imgData, pal){
  const d=imgData.data;
  for(let i=0;i<d.length;i+=4){
    let best=pal[0], min=1e9;
    for(const p of pal){
      const dr=d[i]-p[0], dg=d[i+1]-p[1], db=d[i+2]-p[2];
      const dist=dr*dr+dg*dg+db*db;
      if(dist<min){ min=dist; best=p; }
    }
    d[i]=best[0]; d[i+1]=best[1]; d[i+2]=best[2];
  }
}

fileInput.onchange=e=>{
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=()=>{ img.onload=()=>drawWithPreset('sunset2'); img.src=r.result; };
  r.readAsDataURL(f);
};

function drawWithPreset(key){
  const [w,h]=fitSize(img.width,img.height,parseInt(dotSizeInput.value,10));
  canvas.width=w; canvas.height=h;
  ctx.drawImage(img,0,0,w,h);
  const id=ctx.getImageData(0,0,w,h);
  quantize(id, PRESETS[key]);
  ctx.putImageData(id,0,0);
}

saveAllBtn.onclick = async () => {
  if(!img.src) return alert('画像を選んでください');
  const zip = new JSZip();

  // 元画像
  const orig = await fetch(img.src).then(r=>r.blob());
  zip.file('original.png', orig);

  for(const key in PRESETS){
    drawWithPreset(key);
    const blob = await new Promise(res=>canvas.toBlob(res));
    zip.file(key + '.png', blob);
  }

  const content = await zip.generateAsync({type:'blob'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(content);
  a.download='palette_all.zip';
  a.click();
};
</script>
</body>
</html>